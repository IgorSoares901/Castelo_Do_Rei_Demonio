<!DOCTYPE html>
<html>

<head>
   <title>Personagem controlável e animado</title>
   <script src="/Castelo_Do_Rei_Demonio/js/spritesheet.js"></script> 
   <script src="/Castelo_Do_Rei_Demonio/js/animacao.js"></script> 
   <script src="/Castelo_Do_Rei_Demonio/js/teclado.js"></script> 
   <script src="/Castelo_Do_Rei_Demonio/js/heroina.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/colisor.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/flecha.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/arqueiro.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/osso.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/esqueleto.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/minigodo.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/chefe.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/parallax.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/Hud.js"></script>
   <script src="/Castelo_Do_Rei_Demonio/js/fim.js"></script>
   <link rel="stylesheet" href="styles.css">
</head>

<body>
   <canvas id="canvas_heroina" width="500" height="500"></canvas>
   <script>
      var canvas = document.getElementById('canvas_heroina');
      var context = canvas.getContext('2d');

      var teclado = new Teclado(document); 

      // cria a música ANTES da animação
      const musicaFundo = new Audio("mp3/musica-fundo.mp3");
      musicaFundo.loop = true;
      musicaFundo.volume = 0.4;
      var animacao = new Animacao(context, musicaFundo); 

       // botão de pausa é o enter
      document.addEventListener("keydown", function(e) {
         if (e.keyCode === 13) {
            animacao.togglePause();
         }
      });

      var imgTelaInicial = new Image();
      imgTelaInicial.src = "imagem/parede-porta copia.jpg"

      var imgMapa = new Image();
      imgMapa.src = 'imagem/mapa-principal-2 cortado.png'

      var imgNuvens = new Image();
      imgNuvens.src = 'imagem/floresta1  - Copia.jpg';

      var nuvensLayer3 = new Image();
      nuvensLayer3.src = 'imagem/nuvenslayer-3.png'

      var imgMuros = new Image();
      imgMuros.src = 'imagem/parede-porta copia.jpg'

      var imgSonic = new Image(); 
      imgSonic.src = 'imagem/kitsune-sprite-sheet.png';

      var imgArqueiro = new Image();
      imgArqueiro.src = "imagem/esqueleto-arqueiro.png";
      
      var imgEsqueleto = new Image();
      imgEsqueleto.src = "imagem/esqueleto.png";

      var imgGodo = new Image();
      imgGodo.src = "imagem/Chefe.png"

      var imgChefe = new Image();
      imgChefe.src = "imagem/Chefe.png";

      var sonic = new Sonic(context, teclado, imgSonic);
      sonic.x = -13; 
      sonic.y = 330; 
      animacao.novoSprite(sonic);
      window.heroina = sonic;

    // PARALLAX CONFIG
   var parallax = new Parallax(context);

   imgNuvens.onload = imgMuros.onload = function() {
      // aqui é o seguinte: adicionarcamada(imagem, velocidade, x, y, largura, altura)
      //(imagem, velocidade, posY = 0,posX = 0,ImgAltura=0,ImgLargura=0)
      // a velociedade * como o OFFSET do parallax, cuidado com o valor alto

      parallax.adicionarCamada(imgNuvens, 0.5, 0.5,1,1000); //ta mais lento
      parallax.adicionarCamada(nuvensLayer3, 1.50, 8,75);
      parallax.adicionarCamada(nuvensLayer3, 4.50, 75);
      //parallax.adicionarCamada(imgMuros, 0, 250, 0, 600,1000); //ta mais rapido
   };

   // Adiciona o parallax à animação
   animacao.inserirFundo({
      atualizar: function() {
         parallax.atualizar();
      },
      desenhar: function() {
         parallax.desenhar();
      }
   }, 0);



// colisor
var colisor = new Colisor(context, sonic);

// blocos ajustados pro canvas 5000 x 500 
// primeiros numeros são a posição direita e esquerda
// segundo numero é a posicão cima baixo
// terceiro numero é a largura
// quarto numero é a altura
colisor.adicionarBloco(0, 402, 5000, 50, "chao"); // chão
colisor.adicionarBloco(0, 0, 5, 500, "parede");  // extremidade inicial
colisor.adicionarBloco(4990, 0, 10, 500, "parede");  // extremidade final
colisor.adicionarBloco(55, 336, 82, 15, "plataforma"); // plataforma 1
colisor.adicionarBloco(137, 325, 207, 17, "plataforma"); // plataforma 2
colisor.adicionarBloco(232, 293, 17, 105, "parede");  // parede 1
colisor.adicionarBloco(345, 336, 95, 17, "plataforma"); // plataforma 3
colisor.adicionarBloco(1056, 336, 80, 17, "plataforma"); // plataforma 4
colisor.adicionarBloco(1137, 325, 207, 17, "plataforma"); // plataforma 5
colisor.adicionarBloco(1232, 293, 17, 105, "parede");  // parede 2
colisor.adicionarBloco(1345, 336, 95, 17, "plataforma"); // plataforma 6
colisor.adicionarBloco(1479, 310, 22, 5, "plataforma"); // plataforma mini 2 logo
colisor.adicionarBloco(1495, 300, 5, 5, "plataforma"); // plataforma mini 3
colisor.adicionarBloco(1500, 290, 30, 5, "plataforma"); // plataforma mini 4
colisor.adicionarBloco(1547, 290, 15, 5, "plataforma"); // plataforma mini 5
colisor.adicionarBloco(1547, 291, 1450, 2, "chao"); // chão de cima
colisor.adicionarBloco(3640, 327, 25, 80, "parede");  // parede 3
colisor.adicionarBloco(3738, 327, 25, 80, "parede");  // parede 4
colisor.adicionarBloco(3883, 327, 25, 80, "parede");  // parede 5
colisor.adicionarBloco(3968, 327, 25, 80, "parede");  // parede 6
colisor.adicionarBloco(4259, 374, 35, 30, "parede");  // escada 1
colisor.adicionarBloco(4290, 346, 35, 30, "parede");  // escada 2
colisor.adicionarBloco(4322, 316, 35, 30, "parede");  // escada 3
colisor.adicionarBloco(4352, 286, 35, 30, "parede");  // escada 4
colisor.adicionarBloco(4382, 256, 30, 30, "parede");  // escada 5
colisor.adicionarBloco(4382, 260, 650, 30, "chao"); // chão final
colisor.adicionarBloco(4500, 13, 10, 206, "parede");  // parede chefe
colisor.adicionarBloco(4536, 203, 47, 15, "plataforma"); // plataforma chefe
colisor.adicionarBloco(4619, 175, 47, 15, "plataforma"); // plataforma mini 2
colisor.adicionarBloco(4690, 174, 47, 15, "plataforma"); // plataforma mini 3
colisor.adicionarBloco(4780, 174, 47, 15, "plataforma"); // plataforma mini 4
colisor.adicionarBloco(4850, 174, 47, 15, "plataforma"); // plataforma mini 5
colisor.adicionarBloco(4915, 202, 47, 15, "plataforma"); // plataforma mini 6
colisor.adicionarBloco(4500, 13, 500, 10, "plataforma"); // teto chefe

var camera = {
  x: 0,
  y: 0,
  largura: canvas.width,
  altura: canvas.height,
  mundoLargura: 5000,
  mundoAltura: 500
}; // tive que criar a variavel da camera para o arqueiro saber da existencia dela

//testenado criar varios arqueiros
function criarArqueiros() {
   window.arqueiros = [];
   const posicoes = [
      {x: 70, y: 240},
      {x: 270, y: 227},
      {x: 1160, y: 227},
      {x: 1360, y: 240},
      {x: 650, y: 280},
      {x: 950, y: 280}
   ];

   posicoes.forEach(p => {
      const arqueiro = new Arqueiro(context, imgArqueiro, animacao, camera);
      arqueiro.x = p.x;
      arqueiro.y = p.y;
      arqueiro.colisor = colisor;
      animacao.novoSprite(arqueiro);
      arqueiros.push(arqueiro);
   });
}
// teste criar varios esqueletos
function criarEsqueletos() {
   window.esqueletos = [];
   const posicoes = [
      {x:1600,y:0},
      {x:1800,y:0},
      {x:2000,y:0},
      {x:2300,y:0},
      {x:2600,y:0},
      {x:2850,y:0},
      {x:3690,y:300},
      {x:3819,y:300},
      {x:3925,y:300}
   ];

   posicoes.forEach(p => {
      const e = new Esqueleto(context, imgEsqueleto, animacao, camera);
      e.x = p.x; e.y = p.y; e.colisor = colisor;
      animacao.novoSprite(e);
      esqueletos.push(e);
   });
}
// teste criar varios godos
function criarGodos() {
   window.godos = [];
   const posicoes = [
      {x:1700,y:300},
      {x:2000,y:300},
      {x:2480,y:300},
      {x:2800,y:300},
      {x:3200,y:300}
   ];

   posicoes.forEach(p => {
      const g = new Godo(context, imgGodo, animacao, camera);
      g.x = p.x; g.y = p.y; g.colisor = colisor;
      animacao.novoSprite(g);
      godos.push(g);
   });
}
// teste criar chefe
function criarChefe() {
   window.chefe = [];
   const c = new Chefe(context, imgChefe, animacao, camera);
   c.x = 4800;
   c.y = 20;
   c.colisor = colisor;
   animacao.novoSprite(c);
   chefe.push(c);
}

imgArqueiro.onload = criarArqueiros

imgChefe.onload = criarChefe;

imgEsqueleto.onload = criarEsqueletos;

 imgGodo.onload = criarGodos;


// integrar o colisor à animação
animacao.novoSprite({
  atualizar: function () {
    colisor.checarColisoes();
    
  },
  desenhar: function () {
    colisor.desenhar(); // mostra blocos coloridos
  }
});

//colocar mapa como fundo
      var mapa = {
         context: context,
         imagem: imgMapa,
         x: 0,
         y: 19,
     
      //definir largura e altura do mapa pra ver se n da merda
        
         width: 5000,
         height: 500,

         atualizar: function() {
            // pro mapa n fazer nada
         },
         desenhar: function() {
            this.context.drawImage(this.imagem, this.x, this.y);
         }
      };

      window.hud = new HUD(context, sonic, animacao);

      animacao.inserirFundo(mapa,1);

   // nossa tela de carregamento e musica de fundo estão daqui para baixo
   let jogoIniciado = false;

   // desenha tela inicial
   function desenharTelaInicial() {
  if (imgTelaInicial.complete && imgTelaInicial.naturalWidth > 0) {
    const imgLargura = imgTelaInicial.naturalWidth;
    const imgAltura = imgTelaInicial.naturalHeight;
    const canvasLargura = canvas.width;
    const canvasAltura = canvas.height;
    
    // calcula escala pra caber no canvas mantendo proporção
    // como não é escala 1:1 corta a imagem nas laterais
    const escala = Math.max(canvasLargura / imgLargura, canvasAltura / imgAltura);
    const novaLargura = imgLargura * escala;
    const novaAltura = imgAltura * escala;
    
    // centraliza no canvas
    const offsetX = (canvasLargura - novaLargura) / 2;
    const offsetY = (canvasAltura - novaAltura) / 2;
    
    context.drawImage(imgTelaInicial, offsetX, offsetY, novaLargura, novaAltura);
  } else {
    context.fillStyle = "black";
    context.fillRect(0, 0, canvas.width, canvas.height);
  }// se a imagem não carrega volta pro fundo preto

  

   context.fillStyle = "red"; // cor do titulo
   context.font = "italic bold 35px Arial bold"; // fonte arial bold em negrito e italico
   context.textAlign = "center";
   context.fillText("Castelo do Rei Demônio", canvas.width / 2, 180);

   context.font = "16px Arial bold"; // fonte do subtexto arial bold
   context.fillStyle = "white"; // cor da fonte do subtexto
   context.fillText("Pressione ENTER para começar", canvas.width / 2, 260);
   }

   function loopTelaInicial() {
   if (!jogoIniciado) {
      desenharTelaInicial();
      requestAnimationFrame(loopTelaInicial);
   }
   }
   loopTelaInicial();

   // abre o jogo ao apertar enter e começa a musica
   document.addEventListener("keydown", function (e) {
   if (e.code === "Enter" && !jogoIniciado) {
      jogoIniciado = true;
      musicaFundo.play().catch(()=>{});
      animacao.ligar();
   }
   });

   // tive que tirar o animação.ligar para dar certo a tela de carregamento
   imgSonic.onload = function() {
   // animacao.ligar(); 
   };
      </script>
   </body>


   </html>
